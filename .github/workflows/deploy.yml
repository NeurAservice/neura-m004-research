name: Deploy M004

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  SSH_OPTS: "-o StrictHostKeyChecking=accept-new -o ServerAliveInterval=30 -o ServerAliveCountMax=5 -o ConnectTimeout=30"

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # ssh-keyscan с retry (сервер может быть под нагрузкой)
          KEYSCAN_OK=0
          for attempt in 1 2 3 4 5; do
            echo "ssh-keyscan attempt $attempt/5..."
            if ssh-keyscan -T 15 -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null; then
              if [ -s ~/.ssh/known_hosts ]; then
                echo "✅ ssh-keyscan succeeded on attempt $attempt"
                KEYSCAN_OK=1
                break
              fi
            fi
            echo "  ssh-keyscan failed, waiting 15s..."
            sleep 15
          done

          if [ $KEYSCAN_OK -eq 0 ]; then
            echo "⚠️ ssh-keyscan failed after 5 attempts, using StrictHostKeyChecking=accept-new"
            # Безопасный fallback: принять ключ при первом подключении
            sed -i 's/StrictHostKeyChecking=yes/StrictHostKeyChecking=accept-new/' $GITHUB_ENV 2>/dev/null || true
          fi

      - name: Update code on server
        env:
          HOST: ${{ secrets.SSH_HOST }}
          PORT: ${{ secrets.SSH_PORT }}
          USER: ${{ secrets.SSH_USER }}
        run: |
          # SSH с retry — сервер может быть под нагрузкой и сбрасывать соединения
          ssh_retry() {
            local max_attempts=5
            local delay=20
            for attempt in $(seq 1 $max_attempts); do
              echo "  SSH attempt $attempt/$max_attempts..."
              if ssh $SSH_OPTS -p $PORT $USER@$HOST "$@"; then
                return 0
              fi
              echo "  SSH failed (attempt $attempt), waiting ${delay}s..."
              sleep $delay
            done
            echo "❌ SSH failed after $max_attempts attempts"
            return 1
          }

          ssh_retry bash -c '
            if [ ! -d /opt/neura/m004/.git ]; then
              echo "⚠️ Git repo not found, cloning..."
              git clone https://github.com/NeurAservice/neura-m004-research.git /opt/neura/m004
            fi
            cd /opt/neura/m004
            git fetch origin main
            git reset --hard origin/main
            echo "✅ Code updated to $(git log --oneline -1)"
          '

      - name: Build and restart container
        env:
          HOST: ${{ secrets.SSH_HOST }}
          PORT: ${{ secrets.SSH_PORT }}
          USER: ${{ secrets.SSH_USER }}
        run: |
          ssh_retry() {
            local max_attempts=5
            local delay=20
            for attempt in $(seq 1 $max_attempts); do
              if ssh $SSH_OPTS -p $PORT $USER@$HOST "$@"; then
                return 0
              fi
              echo "  SSH retry $attempt/$max_attempts, waiting ${delay}s..."
              sleep $delay
            done
            return 1
          }

          ssh_retry bash -c '
            cd /opt/neura/m004
            rm -f /tmp/m004-build-exit-code /tmp/m004-build.log

            nohup bash -c "
              docker compose down 2>&1 || true

              BUILD_SUCCESS=0
              for attempt in 1 2 3; do
                echo \"Build attempt \$attempt/3...\"
                if docker compose build 2>&1; then
                  echo \"Build succeeded on attempt \$attempt\"
                  BUILD_SUCCESS=1
                  break
                else
                  echo \"Build failed on attempt \$attempt, waiting 30s...\"
                  sleep 30
                fi
              done

              if [ \$BUILD_SUCCESS -eq 0 ]; then
                echo \"All build attempts failed!\"
                echo 1 > /tmp/m004-build-exit-code
                exit 1
              fi

              docker compose up -d 2>&1
              UP_EXIT=\$?
              sleep 5

              if docker ps --filter name=neura-m004-research --format \"{{.Names}}\" | grep -q neura-m004-research; then
                echo \"Container is running\"
                echo 0 > /tmp/m004-build-exit-code
              else
                echo \"Container failed to start (compose exit: \$UP_EXIT)\"
                docker ps -a --filter name=m004 2>&1
                echo \$UP_EXIT > /tmp/m004-build-exit-code
              fi
            " > /tmp/m004-build.log 2>&1 &
            echo \$!
          '

          echo "⏳ Build started, waiting for completion..."

          for i in $(seq 1 90); do
            sleep 10
            # Polling — одиночные сбои SSH не фатальны
            RESULT=$(ssh $SSH_OPTS -p $PORT $USER@$HOST "cat /tmp/m004-build-exit-code 2>/dev/null || echo RUNNING" 2>/dev/null || echo "SSH_FAIL")
            if [ "$RESULT" = "SSH_FAIL" ]; then
              echo "  ...SSH poll failed (${i}0s elapsed), retrying..."
              continue
            fi
            if [ "$RESULT" != "RUNNING" ]; then
              echo "Build finished with exit code: $RESULT"
              if [ "$RESULT" != "0" ]; then
                echo "❌ Build failed! Last 100 lines of build log:"
                ssh_retry "tail -100 /tmp/m004-build.log" || true
                exit 1
              fi
              break
            fi
            echo "  ...still building (${i}0s elapsed)"
          done

          FINAL=$(ssh_retry "cat /tmp/m004-build-exit-code 2>/dev/null || echo RUNNING" || echo "SSH_FAIL")
          if [ "$FINAL" = "RUNNING" ] || [ "$FINAL" = "SSH_FAIL" ]; then
            echo "❌ Build timed out or SSH unavailable after 15 minutes!"
            ssh_retry "tail -100 /tmp/m004-build.log" || true
            exit 1
          fi

      - name: Health check
        env:
          HOST: ${{ secrets.SSH_HOST }}
          PORT: ${{ secrets.SSH_PORT }}
          USER: ${{ secrets.SSH_USER }}
        run: |
          ssh_retry() {
            local max_attempts=3
            local delay=15
            for attempt in $(seq 1 $max_attempts); do
              if ssh $SSH_OPTS -p $PORT $USER@$HOST "$@" 2>/dev/null; then
                return 0
              fi
              sleep $delay
            done
            return 1
          }

          echo "⏳ Waiting for container to become healthy..."
          sleep 5

          CONTAINER_STATUS=$(ssh_retry "docker ps --filter name=neura-m004-research --format '{{.Status}}'" || true)
          echo "Container status: $CONTAINER_STATUS"

          if [ -z "$CONTAINER_STATUS" ]; then
            echo "❌ Container not found!"
            ssh_retry "docker ps -a --filter name=m004" || true
            ssh_retry "tail -50 /tmp/m004-build.log" || true
            exit 1
          fi

          for i in $(seq 1 24); do
            sleep 5
            HEALTH=$(ssh $SSH_OPTS -p $PORT $USER@$HOST "curl -sf --max-time 5 http://localhost:3004/health 2>&1" 2>/dev/null || true)
            if echo "$HEALTH" | grep -q '"status"'; then
              echo "✅ Health check passed: $HEALTH"
              exit 0
            fi
            echo "  ...attempt $i/24 — not ready yet"
          done

          echo "❌ Health check failed after 120 seconds!"
          ssh_retry "docker logs neura-m004-research --tail 50" || true
          ssh_retry "docker ps -a --filter name=m004" || true
          exit 1

      - name: Cleanup
        if: always()
        env:
          HOST: ${{ secrets.SSH_HOST }}
          PORT: ${{ secrets.SSH_PORT }}
          USER: ${{ secrets.SSH_USER }}
        run: |
          ssh $SSH_OPTS -p $PORT $USER@$HOST "rm -f /tmp/m004-build.log /tmp/m004-build-exit-code" 2>/dev/null || true
